<%- include('../partials/header') %>

  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h2 class="card-title mb-0">Order Details</h2>
            <a href="/designer/dashboard" class="btn btn-outline-primary">Back to Dashboard</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-header">
          <h3>Order #<%= order._id.toString().substring(0, 8) %>...</h3>
        </div>
        <div class="card-body">
          <div class="row mb-4">
            <div class="col-md-6">
              <h5>Order Information</h5>
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between">
                  <span>Order Date:</span>
                  <span>
                    <%= new Date(order.orderDate).toLocaleDateString() %>
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Status:</span>
                  <span class="badge <%= 
                  order.status === 'Pending' ? 'bg-warning' : 
                  order.status === 'Assigned' ? 'bg-info' : 
                  order.status === 'In Progress' ? 'bg-primary' : 
                  order.status === 'Completed' ? 'bg-success' : 
                  'bg-danger' 
                %>">
                    <%= order.status %>
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Quantity:</span>
                  <span>
                    <%= order.quantity %>
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Total Price:</span>
                  <span>â‚¹<%= order.totalPrice.toFixed(2) %></span>
                </li>
              </ul>
            </div>
            <div class="col-md-6">
              <h5>Customer Information</h5>
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between">
                  <span>Name:</span>
                  <span>
                    <%= order.customerId.username %>
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Email:</span>
                  <span>
                    <%= order.customerId.email %>
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Contact:</span>
                  <span>
                    <%= order.customerId.contactNumber %>
                  </span>
                </li>
                <li class="list-group-item">
                  <span>Delivery Address:</span>
                  <p class="mb-0 mt-1">
                    <%= order.deliveryAddress %>
                  </p>
                </li>
              </ul>
            </div>
          </div>

          <div class="mb-4">
            <h5>Designer Actions</h5>
            <div class="row g-2 align-items-end">
              <div class="col-md-5">
                <select id="statusSelect" class="form-select" required>
                  <option value="Accepted" <%=order.status==='Accepted' ? 'selected' : '' %>>Accept Order</option>
                  <option value="In Design" <%=order.status==='In Design' ? 'selected' : '' %>>Mark In Design</option>
                  <option value="Review" <%=order.status==='Review' ? 'selected' : '' %>>Send for Review</option>
                  <option value="In Progress" <%=order.status==='In Progress' ? 'selected' : '' %>>In Production
                  </option>
                  <option value="Completed" <%=order.status==='Completed' ? 'selected' : '' %>>Completed</option>
                  <option value="Cancelled" <%=order.status==='Cancelled' ? 'selected' : '' %>>Cancel</option>
                </select>
              </div>
              <div class="col-md-5">
                <input type="text" id="statusNote" class="form-control" placeholder="Optional note (timeline)">
              </div>
              <div class="col-md-2 d-grid">
                <button id="btnUpdate" class="btn btn-primary">Update</button>
              </div>
            </div>
            <div class="mt-3">
              <label class="form-label">Upload Draft (optional)</label>
              <input type="file" id="draftFile" class="form-control" accept="image/*,application/pdf">
              <small class="text-muted">This demo only stores the status; file uploads can be wired to storage in Phase
                2.</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header">
          <h3>Design Details</h3>
        </div>
        <div class="card-body">
          <div class="text-center mb-3">
            <% /* Display product image based on category for tailor reference */ %>
              <% if (order.designId.category==='Hoodie' ) { %>
                <img src="/images/winter-hoodie.webp" alt="<%= order.designId.name %>" class="img-fluid border rounded"
                  style="max-height: 220px; width: auto; object-fit: cover;">
                <% } else if (order.designId.category==='T-Shirt' ) { %>
                  <img src="/images/casual-tshirt.jpeg" alt="<%= order.designId.name %>"
                    class="img-fluid border rounded" style="max-height: 220px; width: auto; object-fit: cover;">
                  <% } else if (order.designId.category==='Kurthi' ) { %>
                    <img src="/images/kurthi.jpeg" alt="<%= order.designId.name %>" class="img-fluid border rounded"
                      style="max-height: 220px; width: auto; object-fit: cover;">
                    <% } else if (order.designId.category==='Jeans' ) { %>
                      <img src="/images/denim-jeans.webp" alt="<%= order.designId.name %>"
                        class="img-fluid border rounded" style="max-height: 220px; width: auto; object-fit: cover;">
                      <% } else if (order.designId.category==='Dress' ) { %>
                        <img src="/images/women-tshirt.jpeg" alt="<%= order.designId.name %>"
                          class="img-fluid border rounded" style="max-height: 220px; width: auto; object-fit: cover;">
                        <% } else if (order.designId.category==='Shirt' ) { %>
                          <img src="/images/casual-tshirt.jpeg" alt="<%= order.designId.name %>"
                            class="img-fluid border rounded" style="max-height: 220px; width: auto; object-fit: cover;">
                          <% } else { %>
                            <img src="/images/casual-tshirt.jpeg" alt="<%= order.designId.name %>"
                              class="img-fluid border rounded"
                              style="max-height: 220px; width: auto; object-fit: cover;">
                            <% } %>
                              <div class="mt-2">
                                <small class="text-muted">Product Category: <strong>
                                    <%= order.designId.category %>
                                  </strong></small>
                              </div>
          </div>
          <h4>
            <%= order.designId.name %>
          </h4>
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between">
              <span>Fabric:</span>
              <span>
                <%= order.designId.fabric %>
              </span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Color:</span>
              <span>
                <%= order.designId.color %>
              </span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Pattern:</span>
              <span>
                <%= order.designId.pattern %>
              </span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Size:</span>
              <span>
                <%= order.designId.size %>
              </span>
            </li>
          </ul>
          <% if (order.designId.additionalNotes) { %>
            <div class="mt-3">
              <h5>Additional Notes:</h5>
              <p>
                <%= order.designId.additionalNotes %>
              </p>
            </div>
            <% } %>
        </div>
      </div>
    </div>
  </div>

  <%- include('../partials/footer') %>

    <div class="row mt-4">
      <div class="col-md-12">
        <div class="card shadow-sm">
          <div class="card-header">
            <h3>Order Timeline</h3>
          </div>
          <div class="card-body">
            <% if (order.timeline && order.timeline.length) { %>
              <ul class="list-group list-group-flush">
                <% order.timeline.slice().reverse().forEach(ev=> { %>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <strong>
                        <%= ev.status %>
                      </strong>
                      <% if (ev.note) { %>
                        <span class="text-muted"> - <%= ev.note %></span>
                        <% } %>
                    </div>
                    <small class="text-muted">
                      <%= new Date(ev.at).toLocaleString() %>
                    </small>
                  </li>
                  <% }) %>
              </ul>
              <% } else { %>
                <div class="alert alert-info">No timeline entries yet.</div>
                <% } %>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.getElementById('btnUpdate')?.addEventListener('click', async () => {
        const status = document.getElementById('statusSelect').value
        const note = document.getElementById('statusNote')?.value || ''
        try {
          const res = await window.api.post('/designer/update-status/<%= order._id %>', { status, note })
          window.toast('Status updated', 'success')
          // Update badge text/color
          const badge = document.querySelector('.list-group-item .badge')
          if (badge) {
            badge.textContent = res.order.status
            badge.className = 'badge ' + (
              res.order.status === 'Pending' ? 'bg-warning' :
                res.order.status === 'Accepted' ? 'bg-info' :
                  res.order.status === 'In Design' ? 'bg-primary' :
                    res.order.status === 'Review' ? 'bg-secondary' :
                      res.order.status === 'In Progress' ? 'bg-primary' :
                        res.order.status === 'Completed' ? 'bg-success' : 'bg-danger'
            )
          }
        } catch (e) {
          console.error(e)
          window.toast('Failed to update status', 'danger')
        }
      })
    </script>