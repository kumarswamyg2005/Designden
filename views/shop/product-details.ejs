<%- include('../partials/header', { user: typeof user !=='undefined' ? user : undefined }) %>

  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
              <li class="breadcrumb-item"><a href="/">Home</a></li>
              <li class="breadcrumb-item"><a href="/shop">Shop</a></li>
              <li class="breadcrumb-item"><a href="/shop?category=<%= product.category %>">
                  <%= product.category %>
                </a></li>
              <li class="breadcrumb-item active" aria-current="page">
                <%= product.name %>
              </li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-body p-0">
          <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
              <% if (product.images && product.images.length> 0) { %>
                <% product.images.forEach((image, index)=> { %>
                  <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                    <img src="<%= image %>" class="d-block w-100" alt="<%= product.name %>">
                  </div>
                  <% }) %>
                    <% } else { %>
                      <div class="carousel-item active">
                        <img src="/placeholder.svg?height=500&width=500" class="d-block w-100"
                          alt="<%= product.name %>">
                      </div>
                      <% } %>
            </div>
            <% if (product.images && product.images.length> 1) { %>
              <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel"
                data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#productCarousel"
                data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
              </button>
              <% } %>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="card-title">
            <%= product.name %>
          </h2>
          <p class="text-muted mb-2">
            <%= product.category %> | <%= product.gender %>
          </p>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="text-primary mb-0">₹<%= product.price.toFixed(2) %>
            </h3>
            <span class="badge <%= product.inStock ? 'bg-success' : 'bg-danger' %>">
              <%= product.inStock ? 'In Stock' : 'Out of Stock' %>
                <% if (product.stockQuantity !==undefined && product.stockQuantity> 0) { %>
                  (<%= product.stockQuantity %> available)
                    <% } %>
            </span>
          </div>

          <div class="mb-4">
            <p>
              <%= product.description %>
            </p>
          </div>

          <% if (product.inStock) { %>
            <!-- Update the form action for adding to cart -->
            <form action="/customer/add-to-cart" method="POST">
              <input type="hidden" name="productId" value="<%= product._id %>">

              <div class="mb-3">
                <label for="size" class="form-label">Size</label>
                <select class="form-select" id="size" name="size" required>
                  <option value="" selected disabled>Select Size</option>
                  <% product.sizes.forEach(size=> { %>
                    <option value="<%= size %>">
                      <%= size %>
                    </option>
                    <% }) %>
                </select>
              </div>

              <% if (product.colors && product.colors.length> 0) { %>
                <div class="mb-3">
                  <label class="form-label">Color</label>
                  <div class="d-flex flex-wrap gap-2">
                    <% product.colors.forEach(color=> { %>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="color" id="color<%= color %>"
                          value="<%= color %>" required>
                        <label class="form-check-label" for="color<%= color %>">
                          <span class="color-swatch" style="background-color: <%= color.toLowerCase() %>"></span>
                          <%= color %>
                        </label>
                      </div>
                      <% }) %>
                  </div>
                </div>
                <% } %>

                  <div class="mb-3">
                    <label for="quantity" class="form-label">Quantity</label>
                    <input type="number" class="form-control" id="quantity" name="quantity" min="1" value="1" required>
                  </div>

                  <div class="d-grid gap-2">
                    <% if (typeof user !=='undefined' && user) { %>
                      <button type="submit" class="btn btn-primary">Add to Cart</button>
                      <% if (product.customizable) { %>
                        <a href="/shop/customize/<%= product._id %>" class="btn btn-success">Customize This Product</a>
                        <% } %>
                          <% } else { %>
                            <a href="/login" class="btn btn-primary">Login to Add to Cart</a>
                            <% if (product.customizable) { %>
                              <a href="/login" class="btn btn-success">Login to Customize</a>
                              <% } %>
                                <% } %>
                  </div>
            </form>
            <% } else { %>
              <div class="alert alert-danger border-0 shadow-sm">
                <div class="d-flex align-items-center">
                  <i class="fas fa-exclamation-circle fa-2x text-danger me-3"></i>
                  <div>
                    <h5 class="alert-heading mb-1">Out of Stock</h5>
                    <p class="mb-0">This product is currently unavailable. Please check back later or contact us for
                      more information.</p>
                  </div>
                </div>
              </div>
              <div class="d-grid">
                <button type="button" class="btn btn-outline-secondary" disabled>
                  <i class="fas fa-times"></i> Currently Unavailable
                </button>
              </div>
              <% } %>
        </div>
      </div>
    </div>
  </div>

  <% if (relatedProducts && relatedProducts.length> 0) { %>
    <div class="row mt-5">
      <div class="col-md-12">
        <div class="card shadow-sm">
          <div class="card-header">
            <h3>You May Also Like</h3>
          </div>
          <div class="card-body">
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
              <% relatedProducts.forEach(relProduct=> { %>
                <div class="col">
                  <div class="card h-100 product-card">
                    <img
                      src="<%= relProduct.images && relProduct.images.length > 0 ? relProduct.images[0] : '/placeholder.svg?height=200&width=200' %>"
                      class="card-img-top" alt="<%= relProduct.name %>">
                    <div class="card-body">
                      <h5 class="card-title">
                        <%= relProduct.name %>
                      </h5>
                      <p class="card-text text-muted">
                        <%= relProduct.gender %>
                      </p>
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold">₹<%= relProduct.price.toFixed(2) %></span>
                        <a href="/shop/product/<%= relProduct._id %>" class="btn btn-sm btn-outline-primary">View</a>
                      </div>
                    </div>
                  </div>
                </div>
                <% }) %>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% } %>

      <%- include('../partials/footer') %>