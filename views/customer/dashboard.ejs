<%- include('../partials/header') %>

  <% if (typeof orderSuccess !=='undefined' && orderSuccess) { %>
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <h4 class="alert-heading"><i class="fas fa-check-circle"></i> Order Placed Successfully!</h4>
          <p class="mb-2">Your order has been placed and is being processed.</p>
          <hr>
          <p class="mb-0">
            <strong>Order ID:</strong>
            <%= orderSuccess.orderId %><br>
              <strong>Items:</strong>
              <%= orderSuccess.itemCount %><br>
                <strong>Total:</strong> ₹<%= orderSuccess.totalPrice.toFixed(2) %>
          </p>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      </div>
    </div>
    <% } %>

      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="card-title">Welcome, <%= user.username %>
              </h2>
              <p class="card-text">Manage your designs and orders from your personal dashboard.</p>
              <div class="d-flex gap-2">
                <a href="/customer/design-studio" class="btn btn-primary">Create New Design</a>
                <a href="/shop" class="btn btn-success">Shop Ready-Made Designs</a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-12">
          <div class="card shadow-sm">
            <div class="card-header">
              <h3>Your Orders</h3>
            </div>
            <div class="card-body">
              <div id="ordersContainer">
                <div class="text-center py-5 text-muted">Loading your orders...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-12">
          <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h3 class="mb-0">Your Wishlist</h3>
              <a href="/customer/design-studio" class="btn btn-sm btn-outline-primary">Add New</a>
            </div>
            <div class="card-body">
              <div id="wishlistContainer">
                <div class="text-center py-4 text-muted">Loading wishlist...</div>
              </div>
            </div>
          </div>
        </div>


        <%- include('../partials/footer') %>

          <script>
            document.addEventListener('DOMContentLoaded', async () => {
              const container = document.getElementById('ordersContainer')
              const wishlistContainer = document.getElementById('wishlistContainer')
              try {
                const data = await window.api.get('/customer/dashboard')
                const orders = data.orders || []
                if (!orders.length) {
                  container.innerHTML = '<div class="alert alert-info">You don\'t have any orders yet. <a href="/customer/design-studio">Create your first design</a> or <a href="/shop">shop ready-made designs</a> to get started!</div>'
                } else {
                  const rows = orders.map(o => {
                    const idShort = (o._id || '').toString().substring(0, 8) + '...'
                    const date = new Date(o.orderDate).toLocaleDateString()
                    const statusClass = o.status === 'pending' ? 'bg-warning' : o.status === 'assigned' ? 'bg-info' : o.status === 'in_production' ? 'bg-primary' : (o.status === 'completed' || o.status === 'delivered') ? 'bg-success' : o.status === 'shipped' ? 'bg-info' : 'bg-danger'
                    const designName = o.designId && o.designId.name ? o.designId.name : 'Custom Design'
                    const total = typeof o.totalPrice === 'number' ? `₹${o.totalPrice.toFixed(2)}` : '-'
                    const feedbackBtn = (o.status === 'completed' || o.status === 'delivered') ? `<a href="/feedback/submit/${o._id}" class="btn btn-sm btn-outline-success">Leave Feedback</a>` : ''
                    return `<tr>
          <td>${idShort}</td>
          <td>${designName}</td>
          <td>${date}</td>
          <td><span class="badge ${statusClass}">${o.status}</span></td>
          <td>${total}</td>
          <td>
            <a href="/customer/order/${o._id}" class="btn btn-sm btn-outline-primary">View</a>
            ${feedbackBtn}
          </td>
        </tr>`
                  }).join('')
                  container.innerHTML = `<div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Design</th>
              <th>Date</th>
              <th>Status</th>
              <th>Total</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`
                }
                // Load wishlist
                try {
                  const wl = await window.api.get('/customer/wishlist/list')
                  const items = wl.items || []
                  if (!items.length) {
                    wishlistContainer.innerHTML = '<div class="alert alert-info mb-0">No wishlist items yet.</div>'
                  } else {
                    const thumb = (cat) => (
                      cat === 'Hoodie' ? '/images/winter-hoodie.webp' :
                        cat === 'T-Shirt' ? '/images/casual-tshirt.jpeg' :
                          cat === 'Kurthi' ? '/images/kurthi.jpeg' :
                            cat === 'Jeans' ? '/images/denim-jeans.webp' :
                              cat === 'Dress' ? '/images/women-tshirt.jpeg' : '/placeholder.svg?height=160&width=200'
                    )
                    const cards = items.map(d => `
            <div class="col-md-4 mb-3">
              <div class="card h-100">
                <!-- 3D Model Preview Container -->
                <div id="wishlist-3d-${d._id}" style="height: 200px; background: #f8f9fa; position: relative;">
                  <img src="${thumb(d.category)}" alt="${d.name}" style="width: 100%; height: 100%; object-fit: cover;">
                  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px;">
                    <i class="fas fa-cube"></i> 3D Preview
                  </div>
                </div>
                <div class="card-body">
                  <h5 class="card-title">${d.name || 'Wishlist Design'}</h5>
                  <ul class="list-unstyled small mb-3">
                    <li><strong>Fabric:</strong> ${d.fabric}</li>
                    <li><strong>Color:</strong> ${d.color}</li>
                    <li><strong>Pattern:</strong> ${d.pattern}</li>
                    <li><strong>Size:</strong> ${d.size}</li>
                  </ul>
                  <div class="d-flex gap-2">
                    <a href="/customer/place-order/${d._id}" class="btn btn-sm btn-primary">Order Item</a>
                    <button data-id="${d._id}" class="btn btn-sm btn-outline-danger js-remove-wishlist">Remove</button>
                  </div>
                </div>
              </div>
            </div>
          `).join('')
                    wishlistContainer.innerHTML = `<div class="row">${cards}</div>`

                    // bind remove buttons
                    document.querySelectorAll('.js-remove-wishlist').forEach(btn => {
                      btn.addEventListener('click', async () => {
                        if (!confirm('Remove this item from wishlist?')) return
                        const id = btn.getAttribute('data-id')
                        try {
                          await fetch('/customer/wishlist/remove', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ designId: id }) })
                          btn.closest('.col-md-4').remove()
                        } catch (e) {
                          alert('Failed to remove')
                        }
                      })
                    })
                  }
                } catch (e) {
                  wishlistContainer.innerHTML = '<div class="alert alert-danger mb-0">Failed to load wishlist.</div>'
                }
              } catch (e) {
                console.error(e)
                container.innerHTML = '<div class="alert alert-danger">Failed to load orders. Please refresh.</div>'
              }
            })
          </script>