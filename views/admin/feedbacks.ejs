<%- include('../partials/header') %>

  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h2 class="card-title mb-0">Customer Feedbacks</h2>
            <a href="/admin/dashboard" class="btn btn-outline-primary">Back to Dashboard</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-header">
          <h3>All Feedbacks</h3>
        </div>
        <div class="card-body">
          <% if (feedbacks && feedbacks.length> 0) { %>
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Product/Design</th>
                    <th>Rating</th>
                    <th>Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% feedbacks.forEach(feedback=> { %>
                    <tr>
                      <td><small>
                          <%= feedback.orderId._id.toString().substring(0, 8) %>...
                        </small></td>
                      <td>
                        <%= feedback.orderId.customerId.username %>
                      </td>
                      <td>
                        <% if (feedback.orderId.items && feedback.orderId.items.length> 0) { %>
                          <% const firstItem=feedback.orderId.items[0]; %>
                            <% if (firstItem.customizationId) { %>
                              <% if (firstItem.customizationId.designId) { %>
                                <span class="badge bg-primary">Custom</span>
                                <small>
                                  <%= firstItem.customizationId.designId.name %>
                                </small>
                                <% } else if (firstItem.customizationId.productId) { %>
                                  <span class="badge bg-success">Shop</span>
                                  <small>
                                    <%= firstItem.customizationId.productId.name %>
                                  </small>
                                  <% } else { %>
                                    <small class="text-muted">N/A</small>
                                    <% } %>
                                      <% } else { %>
                                        <small class="text-muted">N/A</small>
                                        <% } %>
                                          <% } else { %>
                                            <small class="text-muted">N/A</small>
                                            <% } %>
                      </td>
                      <td>
                        <div class="text-warning">
                          <% for (let i=0; i < feedback.rating; i++) { %>
                            <i class="fas fa-star"></i>
                            <% } %>
                              <% for (let i=feedback.rating; i < 5; i++) { %>
                                <i class="far fa-star"></i>
                                <% } %>
                        </div>
                        <small class="text-muted">(<%= feedback.rating %>/5)</small>
                      </td>
                      <td><small>
                          <%= new Date(feedback.createdAt).toLocaleDateString() %>
                        </small></td>
                      <td>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                          data-bs-target="#feedbackModal<%= feedback._id %>">
                          View
                        </button>

                        <!-- Feedback Modal -->
                        <div class="modal fade" id="feedbackModal<%= feedback._id %>" tabindex="-1"
                          aria-labelledby="feedbackModalLabel<%= feedback._id %>" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="feedbackModalLabel<%= feedback._id %>">Feedback Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                  aria-label="Close"></button>
                              </div>
                              <div class="modal-body">
                                <div class="mb-3">
                                  <h6>Order Information</h6>
                                  <p><strong>Order ID:</strong>
                                    <%= feedback.orderId._id.toString().substring(0, 8) %>...
                                  </p>
                                  <% if (feedback.orderId.items && feedback.orderId.items.length> 0) { %>
                                    <% const firstItem=feedback.orderId.items[0]; %>
                                      <% if (firstItem.customizationId) { %>
                                        <% if (firstItem.customizationId.designId) { %>
                                          <p><strong>Design:</strong>
                                            <%= firstItem.customizationId.designId.name %>
                                          </p>
                                          <% } else if (firstItem.customizationId.productId) { %>
                                            <p><strong>Product:</strong>
                                              <%= firstItem.customizationId.productId.name %>
                                            </p>
                                            <% } %>
                                              <% } %>
                                                <% } %>
                                                  <p><strong>Date:</strong>
                                                    <%= new Date(feedback.orderId.orderDate).toLocaleDateString() %>
                                                  </p>
                                                  <p><strong>Total:</strong> â‚¹<%= (feedback.orderId.totalPrice ||
                                                      0).toFixed(2) %>
                                                  </p>
                                </div>
                                <div class="mb-3">
                                  <h6>Customer</h6>
                                  <p><strong>Name:</strong>
                                    <%= feedback.orderId.customerId.username %>
                                  </p>
                                  <p><strong>Email:</strong>
                                    <%= feedback.orderId.customerId.email %>
                                  </p>
                                </div>
                                <div class="mb-3">
                                  <h6>Rating</h6>
                                  <div class="text-warning" style="font-size: 1.5rem;">
                                    <% for (let i=0; i < feedback.rating; i++) { %>
                                      <i class="fas fa-star"></i>
                                      <% } %>
                                        <% for (let i=feedback.rating; i < 5; i++) { %>
                                          <i class="far fa-star"></i>
                                          <% } %>
                                            <span class="text-dark ms-2" style="font-size: 1rem;">(<%= feedback.rating
                                                %>/5)</span>
                                  </div>
                                </div>
                                <div class="mb-3">
                                  <h6>Comments</h6>
                                  <p class="bg-light p-3 rounded">
                                    <%= feedback.comments %>
                                  </p>
                                </div>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </td>
                    </tr>
                    <% }) %>
                </tbody>
              </table>
            </div>
            <% } else { %>
              <div class="alert alert-info">
                There are no feedbacks yet.
              </div>
              <% } %>
        </div>
      </div>
    </div>
  </div>

  <%- include('../partials/footer') %>