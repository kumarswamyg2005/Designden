<%- include('../partials/header') %>

  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h2 class="card-title mb-0">Order Details</h2>
            <a href="/admin/dashboard" class="btn btn-outline-primary">Back to Dashboard</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-header">
          <h3>Order #<%= order._id.toString().substring(0, 8) %>...</h3>
        </div>
        <div class="card-body">
          <div class="row mb-4">
            <div class="col-md-6">
              <h5>Order Information</h5>
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between">
                  <span>Order Date:</span>
                  <span>
                    <%= new Date(order.orderDate).toLocaleDateString() %>
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Status:</span>
                  <span class="badge <%= 
                  order.status === 'Pending' ? 'bg-warning' : 
                  order.status === 'Assigned' ? 'bg-info' : 
                  order.status === 'In Progress' ? 'bg-primary' : 
                  order.status === 'Completed' ? 'bg-success' : 
                  'bg-danger' 
                %>">
                    <%= order.status %>
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Quantity:</span>
                  <span>
                    <%= order.quantity %>
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Total Price:</span>
                  <span>â‚¹<%= order.totalPrice.toFixed(2) %></span>
                </li>
              </ul>
            </div>
            <div class="col-md-6">
              <h5>Customer Information</h5>
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between">
                  <span>Name:</span>
                  <span>
                    <%= order.customerId.username %>
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Email:</span>
                  <span>
                    <%= order.customerId.email %>
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Contact:</span>
                  <span>
                    <%= order.customerId.contactNumber %>
                  </span>
                </li>
                <li class="list-group-item">
                  <span>Delivery Address:</span>
                  <p class="mb-0 mt-1">
                    <%= order.deliveryAddress %>
                  </p>
                </li>
              </ul>
            </div>
          </div>

          <div class="mb-4">
            <h5>Update Order Status</h5>
            <form action="/admin/order/<%= order._id %>/update-status" method="POST" class="row g-2 align-items-end"
              id="updateStatusForm" novalidate>
              <div class="col-md-6">
                <select name="status" id="adminStatusSelect" class="form-select" required>
                  <option value="Pending" <%=order.status==='Pending' ? 'selected' : '' %>>Pending</option>
                  <option value="Assigned" <%=order.status==='Assigned' ? 'selected' : '' %>>Assigned</option>
                  <option value="In Progress" <%=order.status==='In Progress' ? 'selected' : '' %>>In Progress
                  </option>
                  <option value="In Production" <%=order.status==='In Production' ? 'selected' : '' %>>In Production
                  </option>
                  <option value="Completed" <%=order.status==='Completed' ? 'selected' : '' %>>Completed</option>
                  <option value="Cancelled" <%=order.status==='Cancelled' ? 'selected' : '' %>>Cancelled</option>
                </select>
                <div class="invalid-feedback">
                  Please select a status.
                </div>
              </div>
              <div class="col-md-6">
                <input type="text" name="note" id="statusNote" class="form-control"
                  placeholder="Optional note (visible in timeline)" maxlength="500">
                <div class="invalid-feedback">
                  Note must be less than 500 characters.
                </div>
              </div>
              <div class="col-md-3 d-grid">
                <button type="submit" class="btn btn-primary">Update Status</button>
              </div>
            </form>
          </div>

          <% if (order.status==='Pending' ) { %>
            <div class="mb-4">
              <h5>Assign to Designer</h5>
              <form action="/admin/assign-order/<%= order._id %>" method="POST" id="assignDesignerForm" novalidate>
                <div class="mb-3">
                  <select class="form-select" name="designerId" id="designerSelect" required>
                    <option value="" selected disabled>Choose a designer</option>
                    <% designers.filter(d=> d.email === 'tailor@designden.com').forEach(designer => { %>
                      <option value="<%= designer._id %>">
                        <%= designer.username %> (<%= designer.email %>)
                      </option>
                      <% }) %>
                  </select>
                  <div class="invalid-feedback">
                    Please select a designer to assign the order.
                  </div>
                </div>
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary">Assign Order</button>
                </div>
              </form>
            </div>
            <% } else if (order.designerId) { %>
              <div class="mb-4">
                <h5>Assigned Designer</h5>
                <ul class="list-group list-group-flush">
                  <li class="list-group-item d-flex justify-content-between">
                    <span>Name:</span>
                    <span>
                      <%= order.designerId.username %>
                    </span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between">
                    <span>Email:</span>
                    <span>
                      <%= order.designerId.email %>
                    </span>
                  </li>
                </ul>
              </div>
              <% } %>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header">
          <h3>Design Details</h3>
        </div>
        <div class="card-body">
          <div class="text-center mb-3">
            <% /* Display product image based on category for admin/tailor reference */ %>
              <% if (order.designId.category==='Hoodie' ) { %>
                <img src="/images/winter-hoodie.webp" alt="<%= order.designId.name %>" class="img-fluid border rounded"
                  style="max-height: 220px; width: auto; object-fit: cover;">
                <% } else if (order.designId.category==='T-Shirt' ) { %>
                  <img src="/images/casual-tshirt.jpeg" alt="<%= order.designId.name %>"
                    class="img-fluid border rounded" style="max-height: 220px; width: auto; object-fit: cover;">
                  <% } else if (order.designId.category==='Kurthi' ) { %>
                    <img src="/images/kurthi.jpeg" alt="<%= order.designId.name %>" class="img-fluid border rounded"
                      style="max-height: 220px; width: auto; object-fit: cover;">
                    <% } else if (order.designId.category==='Jeans' ) { %>
                      <img src="/images/denim-jeans.webp" alt="<%= order.designId.name %>"
                        class="img-fluid border rounded" style="max-height: 220px; width: auto; object-fit: cover;">
                      <% } else if (order.designId.category==='Dress' ) { %>
                        <img src="/images/women-tshirt.jpeg" alt="<%= order.designId.name %>"
                          class="img-fluid border rounded" style="max-height: 220px; width: auto; object-fit: cover;">
                        <% } else if (order.designId.category==='Shirt' ) { %>
                          <img src="/images/casual-tshirt.jpeg" alt="<%= order.designId.name %>"
                            class="img-fluid border rounded" style="max-height: 220px; width: auto; object-fit: cover;">
                          <% } else { %>
                            <img src="/images/casual-tshirt.jpeg" alt="<%= order.designId.name %>"
                              class="img-fluid border rounded"
                              style="max-height: 220px; width: auto; object-fit: cover;">
                            <% } %>
                              <div class="mt-2">
                                <small class="text-muted">Product Category: <strong>
                                    <%= order.designId.category %>
                                  </strong></small>
                              </div>
          </div>

          <div class="row mt-4">
            <div class="col-md-12">
              <div class="card shadow-sm">
                <div class="card-header d-flex align-items-center justify-content-between">
                  <h3 class="mb-0">Order Timeline</h3>
                </div>
                <div class="card-body">
                  <% if (order.timeline && order.timeline.length) { %>
                    <ul class="list-group list-group-flush">
                      <% order.timeline.slice().reverse().forEach(ev=> {
                        const isProgressUpdate = ev.note && ev.note.includes('Progress Update:');
                        const percentMatch = isProgressUpdate ? ev.note.match(/(\d+)% complete/) : null;
                        const percentage = percentMatch ? percentMatch[1] : '0';
                        %>
                        <li class="list-group-item <%= isProgressUpdate ? 'bg-light' : '' %>">
                          <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                              <div class="d-flex align-items-center mb-1">
                                <% if (isProgressUpdate) { %>
                                  <% if (parseInt(percentage)>= 75) { %>
                                    <span class="badge bg-success me-2">ðŸŽ‰ <%= percentage %>% Complete</span>
                                    <% } else if (parseInt(percentage)>= 50) { %>
                                      <span class="badge bg-info me-2">âš¡ <%= percentage %>% Complete</span>
                                      <% } else { %>
                                        <span class="badge bg-primary me-2">ðŸ”¨ <%= percentage %>% Complete</span>
                                        <% } %>
                                          <% } else { %>
                                            <strong class="text-capitalize">
                                              <%= ev.status.replace('_', ' ' ) %>
                                            </strong>
                                            <% } %>
                                              <small class="text-muted ms-2">
                                                <%= new Date(ev.at).toLocaleString() %>
                                              </small>
                              </div>
                              <% if (ev.note) { %>
                                <p class="mb-1 <%= isProgressUpdate ? 'text-dark fw-bold' : 'text-muted' %>">
                                  <%= ev.note.replace('Progress Update: ', '') %>
                                </p>
                              <% } %>
                              <% if (isProgressUpdate) { %>
                                <div class="progress mt-2" style="height: 8px;">
                                  <div class="progress-bar <%= parseInt(percentage) >= 75 ? ' bg-success' :
                                    parseInt(percentage)>= 50 ? 'bg-info' : 'bg-primary' %>"
                                    role="progressbar"
                                    style="width: <%= percentage %>%;"
                                      aria-valuenow="<%= percentage %>"
                                        aria-valuemin="0"
                                        aria-valuemax="100">
                            </div>
                          </div>
                          <% } %>
                </div>
              </div>
              </li>
              <% }) %>
                </ul>
                <% } else { %>
                  <div class="alert alert-info">No timeline entries yet.</div>
                  <% } %>
            </div>
          </div>
        </div>
      </div>
      <h4>
        <%= order.designId.name %>
      </h4>
      <ul class="list-group list-group-flush">
        <li class="list-group-item d-flex justify-content-between">
          <span>Fabric:</span>
          <span>
            <%= order.designId.fabric %>
          </span>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span>Color:</span>
          <span>
            <%= order.designId.color %>
          </span>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span>Pattern:</span>
          <span>
            <%= order.designId.pattern %>
          </span>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span>Size:</span>
          <span>
            <%= order.designId.size %>
          </span>
        </li>
      </ul>
      <% if (order.designId.additionalNotes) { %>
        <div class="mt-3">
          <h5>Additional Notes:</h5>
          <p>
            <%= order.designId.additionalNotes %>
          </p>
        </div>
        <% } %>
    </div>
  </div>
  </div>
  </div>

  <script>
    // Form validation for admin forms
    (function () {
      'use strict';

      const updateStatusForm = document.getElementById('updateStatusForm');
      const assignDesignerForm = document.getElementById('assignDesignerForm');

      // Update Status Form Validation
      if (updateStatusForm) {
        const statusSelect = document.getElementById('adminStatusSelect');
        const noteInput = document.getElementById('statusNote');

        noteInput.addEventListener('input', function () {
          if (this.value.length > 500) {
            this.classList.add('is-invalid');
            this.classList.remove('is-valid');
          } else if (this.value.length > 0) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
          } else {
            this.classList.remove('is-invalid');
            this.classList.remove('is-valid');
          }
        });

        updateStatusForm.addEventListener('submit', function (event) {
          let isValid = true;

          if (!statusSelect.value) {
            statusSelect.classList.add('is-invalid');
            isValid = false;
          }

          if (noteInput.value.length > 500) {
            noteInput.classList.add('is-invalid');
            isValid = false;
          }

          if (!isValid || !updateStatusForm.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }

          updateStatusForm.classList.add('was-validated');
        }, false);
      }

      // Assign Designer Form Validation
      if (assignDesignerForm) {
        const designerSelect = document.getElementById('designerSelect');

        assignDesignerForm.addEventListener('submit', function (event) {
          if (!designerSelect.value) {
            designerSelect.classList.add('is-invalid');
            event.preventDefault();
            event.stopPropagation();
          }

          assignDesignerForm.classList.add('was-validated');
        }, false);
      }
    })();
  </script>

  <%- include('../partials/footer') %>