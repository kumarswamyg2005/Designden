# üöÄ DesignDen - Quick Reference Guide

## üìö Documentation Files

1. **PROBLEMS_FOUND_SUMMARY.md** - Complete analysis of problems found and fixed
2. **WORKFLOW_FIXED.md** - Detailed workflow implementation guide
3. **IMPLEMENTATION_SUMMARY.md** - What needs to be done next
4. **This File** - Quick reference for developers

---

## ‚úÖ What's Already Done

### **‚úîÔ∏è Database Models (100% Complete)**

- User model (4 roles only)
- CustomerProfile
- DesignerProfile
- DesignTemplate
- Order (correct statuses)
- Cart (correct structure)
- Customization (fabric-based)
- Fabric (already existed)
- Transaction, Notification, Feedback (already existed)

### **‚úîÔ∏è Security Utilities (100% Complete)**

- Password hashing (bcrypt)
- Input validation
- XSS prevention
- Timing-safe comparison
- File upload (Multer)

### **‚úîÔ∏è Dependencies (100% Complete)**

```bash
‚úÖ bcrypt
‚úÖ multer
```

### **‚úîÔ∏è Documentation (100% Complete)**

- Complete workflow documentation
- Implementation guide
- Problems analysis
- CodeRabbit security findings

---

## ‚è≥ What Needs Implementation

### **Priority 1: Authentication**

File: `routes/auth.js`

```javascript
// TODO: Update POST /signup
- Hash password with utils/password.hashPassword()
- Create CustomerProfile if role=customer
- Create DesignerProfile if role=designer (status=pending)

// TODO: Update POST /login
- Use utils/password.comparePassword() instead of plaintext
- Validate inputs with utils/validation
```

### **Priority 2: Customer Routes**

File: `routes/customer.js`

```javascript
// NEW Routes Needed:
GET  /fabrics                      // Browse fabric catalog
GET  /fabrics/:id/customize        // Customization studio
POST /fabrics/:id/customize        // Create customization ‚Üí add to cart
GET  /customer/cart                // View cart
POST /customer/cart/remove/:id     // Remove from cart
GET  /customer/checkout            // Checkout page
POST /customer/checkout            // Create order
POST /customer/pay/:orderId        // Dummy payment
GET  /customer/orders              // Order history
GET  /customer/orders/:id          // Order details
```

### **Priority 3: Manager Routes**

File: `routes/manager.js`

```javascript
// REWRITE Needed:
GET  /manager/dashboard                     // Orders grouped by status
POST /manager/orders/:id/start-production  // pending ‚Üí in_production
POST /manager/orders/:id/complete          // in_production ‚Üí completed
POST /manager/orders/:id/ship              // completed ‚Üí shipped
POST /manager/orders/:id/deliver           // shipped ‚Üí delivered

// Must validate status transitions!
// Must use MongoDB transactions!
```

### **Priority 4: Designer Routes**

File: `routes/designer.js`

```javascript
// REWRITE Needed:
GET  /designer/pending                // Waiting for approval
GET  /designer/dashboard              // Earnings dashboard
GET  /designer/templates              // My templates
GET  /designer/templates/new          // Create template form
POST /designer/templates              // Create template
PUT  /designer/templates/:id          // Update template
DELETE /designer/templates/:id        // Delete template
```

### **Priority 5: Admin Routes**

File: `routes/admin.js`

```javascript
// ADD New Routes:
GET  /admin/designers                 // List all designers
POST /admin/designers/:id/approve     // Approve designer
POST /admin/designers/:id/reject      // Reject designer
GET  /admin/fabrics                   // Manage fabrics
POST /admin/fabrics                   // Add fabric
PUT  /admin/fabrics/:id               // Update fabric
DELETE /admin/fabrics/:id             // Delete fabric
```

---

## üìÇ Directory Structure

```
design-den-main/
‚îú‚îÄ‚îÄ models/                     ‚úÖ COMPLETE
‚îÇ   ‚îú‚îÄ‚îÄ user.js                 ‚úÖ Fixed (4 roles)
‚îÇ   ‚îú‚îÄ‚îÄ customerProfile.js      ‚úÖ New
‚îÇ   ‚îú‚îÄ‚îÄ designerProfile.js      ‚úÖ New
‚îÇ   ‚îú‚îÄ‚îÄ designTemplate.js       ‚úÖ New
‚îÇ   ‚îú‚îÄ‚îÄ order.js                ‚úÖ Fixed (correct statuses)
‚îÇ   ‚îú‚îÄ‚îÄ cart.js                 ‚úÖ Fixed (new structure)
‚îÇ   ‚îú‚îÄ‚îÄ customization.js        ‚úÖ Fixed (fabric-based)
‚îÇ   ‚îî‚îÄ‚îÄ fabric.js               ‚úÖ Exists
‚îÇ
‚îú‚îÄ‚îÄ utils/                      ‚úÖ COMPLETE
‚îÇ   ‚îú‚îÄ‚îÄ password.js             ‚úÖ bcrypt utilities
‚îÇ   ‚îú‚îÄ‚îÄ validation.js           ‚úÖ Input validation
‚îÇ   ‚îú‚îÄ‚îÄ security.js             ‚úÖ Timing-safe comparison
‚îÇ   ‚îî‚îÄ‚îÄ upload.js               ‚úÖ Multer config
‚îÇ
‚îú‚îÄ‚îÄ routes/                     ‚è≥ NEEDS UPDATE
‚îÇ   ‚îú‚îÄ‚îÄ auth.js                 ‚è≥ Add bcrypt
‚îÇ   ‚îú‚îÄ‚îÄ customer.js             ‚è≥ Rewrite for fabric workflow
‚îÇ   ‚îú‚îÄ‚îÄ designer.js             ‚è≥ Rewrite for templates
‚îÇ   ‚îú‚îÄ‚îÄ manager.js              ‚è≥ Rewrite for order workflow
‚îÇ   ‚îî‚îÄ‚îÄ admin.js                ‚è≥ Add designer approval
‚îÇ
‚îú‚îÄ‚îÄ views/                      ‚è≥ NEEDS UPDATE
‚îÇ   ‚îú‚îÄ‚îÄ fabrics/                ‚è≥ Create (catalog, customize)
‚îÇ   ‚îú‚îÄ‚îÄ customer/               ‚è≥ Update (cart, checkout, payment)
‚îÇ   ‚îú‚îÄ‚îÄ designer/               ‚è≥ Create (templates, earnings)
‚îÇ   ‚îî‚îÄ‚îÄ manager/                ‚è≥ Update (dashboard)
‚îÇ
‚îú‚îÄ‚îÄ seed/                       ‚è≥ NEEDS UPDATE
‚îÇ   ‚îî‚îÄ‚îÄ fabrics.js              ‚è≥ Create fabric seed data
‚îÇ
‚îî‚îÄ‚îÄ public/uploads/             ‚úÖ Created
```

---

## üéØ Correct Order Statuses

```javascript
// ONLY THESE STATUSES (6 total):
const ORDER_STATUSES = {
  PENDING: 'pending',           // Customer placed order, waiting for payment
  IN_PRODUCTION: 'in_production', // Manager started production
  COMPLETED: 'completed',       // Production done, ready to ship
  SHIPPED: 'shipped',          // Order shipped
  DELIVERED: 'delivered',      // Order delivered
  CANCELLED: 'cancelled'       // Order cancelled
};

// Status Transitions:
pending ‚Üí in_production (Manager only, if paid)
in_production ‚Üí completed (Manager only)
completed ‚Üí shipped (Manager only)
shipped ‚Üí delivered (Manager only)
any ‚Üí cancelled (Manager/Admin only)
```

---

## üîë Authentication Example

### **Signup (with bcrypt)**

```javascript
const { hashPassword } = require("../utils/password");
const {
  validateRequiredFields,
  sanitizeString,
} = require("../utils/validation");

router.post("/signup", async (req, res) => {
  // 1. Validate
  const validation = validateRequiredFields(req.body, [
    "username",
    "email",
    "password",
    "contactNumber",
  ]);
  if (!validation.valid) {
    return res.render("signup", {
      error: "Missing required fields",
      formData: req.body,
    });
  }

  // 2. Sanitize
  const username = sanitizeString(req.body.username, 50);
  const email = sanitizeString(req.body.email, 100);
  const password = req.body.password; // Don't sanitize password
  const role = req.body.role || "customer";

  // 3. Hash password
  const hashedPassword = await hashPassword(password);

  // 4. Create user
  const user = new User({
    username,
    email,
    password: hashedPassword, // HASHED!
    contactNumber: req.body.contactNumber,
    role,
  });
  await user.save();

  // 5. Create profile
  if (role === "customer") {
    await CustomerProfile.create({ userId: user._id });
  } else if (role === "designer") {
    await DesignerProfile.create({
      userId: user._id,
      status: "pending",
    });
  }

  // 6. Login user
  req.session.user = {
    id: user._id,
    username: user.username,
    email: user.email,
    role: user.role,
  };

  res.redirect(`/${role}/dashboard`);
});
```

### **Login (with bcrypt)**

```javascript
const { comparePassword } = require("../utils/password");

router.post("/login", async (req, res) => {
  const { email, password } = req.body;

  // 1. Find user
  const user = await User.findOne({
    $or: [{ email }, { username: email }],
  });

  if (!user) {
    return res.render("login", { error: "Invalid credentials" });
  }

  // 2. Compare password with bcrypt
  const isValid = await comparePassword(password, user.password);

  if (!isValid) {
    return res.render("login", { error: "Invalid credentials" });
  }

  // 3. Check designer approval
  if (user.role === "designer") {
    const profile = await DesignerProfile.findOne({ userId: user._id });
    if (profile.status !== "approved") {
      return res.redirect("/designer/pending");
    }
  }

  // 4. Login user
  req.session.user = {
    id: user._id,
    username: user.username,
    email: user.email,
    role: user.role,
  };

  res.redirect(`/${user.role}/dashboard`);
});
```

---

## üõçÔ∏è Customer Workflow Example

### **Fabric Customization with Image Upload**

```javascript
const upload = require("../utils/upload");

router.post(
  "/fabrics/:id/customize",
  upload.single("customImage"),
  async (req, res) => {
    try {
      const fabric = await Fabric.findById(req.params.id);

      // Create customization
      const customization = new Customization({
        userId: req.session.user.id,
        fabricId: fabric._id,
        customImage: req.file ? req.file.filename : null, // Uploaded image
        customText: req.body.customText,
        color: req.body.color,
        size: req.body.size,
        price: fabric.pricePerMeter * 2, // Example pricing
      });
      await customization.save();

      // Add to cart
      let cart = await Cart.findOne({ userId: req.session.user.id });
      if (!cart) {
        cart = new Cart({ userId: req.session.user.id, items: [] });
      }

      cart.items.push({
        customizationId: customization._id,
        quantity: 1,
      });
      await cart.save();

      res.redirect("/customer/cart");
    } catch (error) {
      console.error(error);
      res.status(500).send("Error creating customization");
    }
  }
);
```

---

## üë®‚Äçüíº Manager Workflow Example

### **Start Production (with validation)**

```javascript
router.post("/orders/:id/start-production", async (req, res) => {
  try {
    const order = await Order.findById(req.params.id);

    // VALIDATE
    if (!order) {
      return res.status(404).json({ error: "Order not found" });
    }

    if (order.status !== "pending") {
      return res.status(400).json({
        error: "Cannot start production",
        currentStatus: order.status,
      });
    }

    if (order.paymentStatus !== "paid") {
      return res.status(400).json({
        error: "Order must be paid first",
      });
    }

    // UPDATE
    order.status = "in_production";
    order.productionStartedAt = new Date();
    await order.save();

    // NOTIFY
    await Notification.create({
      userId: order.customerId,
      title: "Production Started",
      message: `Your order #${order._id} is now in production!`,
      meta: { orderId: order._id },
    });

    res.json({ success: true, order });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
```

---

## üé® Designer Earnings Example

```javascript
router.get("/designer/dashboard", async (req, res) => {
  // Get designer's templates
  const templates = await DesignTemplate.find({
    designerId: req.session.user.id,
  });

  // Calculate earnings
  let totalEarnings = 0;
  const templatesWithEarnings = [];

  for (const template of templates) {
    // Count how many times template was used
    const usageCount = await Customization.countDocuments({
      designTemplateId: template._id,
    });

    const earnings = usageCount * template.commissionRate; // e.g., uses √ó $5
    totalEarnings += earnings;

    templatesWithEarnings.push({
      ...template.toObject(),
      usageCount,
      earnings,
    });
  }

  // Update profile
  await DesignerProfile.updateOne(
    { userId: req.session.user.id },
    { totalEarnings }
  );

  res.render("designer/dashboard", {
    user: req.session.user,
    templates: templatesWithEarnings,
    totalEarnings,
  });
});
```

---

## üîí Security Checklist

- [ ] All passwords hashed with bcrypt
- [ ] All inputs validated before use
- [ ] All user data escaped in views (XSS prevention)
- [ ] Debug endpoints restricted to development
- [ ] Token comparison uses timingSafeEqual
- [ ] File uploads validated (type, size)
- [ ] MongoDB transactions for atomic operations
- [ ] CSRF protection added
- [ ] Rate limiting on auth routes

---

## üß™ Testing Workflow

```bash
# 1. Start server
node app.js

# 2. Test Customer Flow
1. Register as customer ‚Üí Check CustomerProfile created
2. Browse fabrics ‚Üí Check fabric list displays
3. Customize fabric ‚Üí Upload image, check saved to /uploads
4. View cart ‚Üí Check customization in cart
5. Checkout ‚Üí Check order created (status=pending, paymentStatus=unpaid)
6. Pay ‚Üí Check paymentStatus=paid
7. Track order ‚Üí Check status updates

# 3. Test Designer Flow
1. Register as designer ‚Üí Check DesignerProfile created (status=pending)
2. Try to create template ‚Üí Should redirect to /designer/pending
3. Admin approves ‚Üí Check status=approved
4. Create template ‚Üí Upload image, check saved
5. Customer uses template ‚Üí Check usageCount increments
6. Check earnings ‚Üí Verify calculation (uses √ó $5)

# 4. Test Manager Flow
1. View dashboard ‚Üí Check orders grouped by status
2. Try start production on unpaid order ‚Üí Should fail
3. Start production on paid order ‚Üí Check status changes
4. Complete ‚Üí Check status transition
5. Ship ‚Üí Check status transition
6. Deliver ‚Üí Check status=delivered

# 5. Test Admin Flow
1. View pending designers ‚Üí Check list
2. Approve designer ‚Üí Check status updates
3. Manage fabrics ‚Üí CRUD operations
4. Manage users ‚Üí Block/unblock
```

---

## üìö API Endpoints Reference

### **Authentication**

```
POST /signup          - Register new user
POST /login           - Login user
GET  /logout          - Logout user
```

### **Customer**

```
GET  /fabrics                    - Browse fabric catalog
GET  /fabrics/:id/customize      - Customization studio
POST /fabrics/:id/customize      - Create customization
GET  /customer/cart              - View cart
POST /customer/cart/remove/:id   - Remove from cart
GET  /customer/checkout          - Checkout page
POST /customer/checkout          - Create order
POST /customer/pay/:id           - Dummy payment
GET  /customer/orders            - Order history
GET  /customer/orders/:id        - Order details
```

### **Designer**

```
GET    /designer/pending          - Waiting for approval
GET    /designer/dashboard        - Earnings dashboard
GET    /designer/templates        - My templates
GET    /designer/templates/new    - Create template form
POST   /designer/templates        - Create template
PUT    /designer/templates/:id    - Update template
DELETE /designer/templates/:id    - Delete template
```

### **Manager**

```
GET  /manager/dashboard                  - Orders dashboard
POST /manager/orders/:id/start           - Start production
POST /manager/orders/:id/complete        - Mark complete
POST /manager/orders/:id/ship            - Ship order
POST /manager/orders/:id/deliver         - Mark delivered
```

### **Admin**

```
GET  /admin/dashboard              - Admin dashboard
GET  /admin/designers              - List all designers
POST /admin/designers/:id/approve  - Approve designer
POST /admin/designers/:id/reject   - Reject designer
GET  /admin/fabrics                - Manage fabrics
POST /admin/fabrics                - Add fabric
PUT  /admin/fabrics/:id            - Update fabric
DELETE /admin/fabrics/:id          - Delete fabric
```

---

## üéì Summary

### **Foundation:** ‚úÖ 100% Complete

- Database models fixed
- Security utilities created
- Dependencies installed
- Documentation complete

### **Next Steps:** ‚è≥ Implementation

1. Update auth routes (bcrypt)
2. Rewrite customer routes
3. Rewrite manager routes
4. Rewrite designer routes
5. Update admin routes
6. Create/update views
7. Test workflows

**You now have everything you need to implement the corrected workflow!** üöÄ
